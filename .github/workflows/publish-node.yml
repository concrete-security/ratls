# Publish @concrete-security/atlas-node to npm
#
# How to release:
#   1. Update version in node/package.json
#   2. Commit and push the change
#   3. Run this workflow with dry_run=false
#
# The workflow will:
#   - Build for all platforms (using native runners)
#   - Create git tag: node/<version>
#   - Create draft GitHub release
#   - Publish to npm

name: Publish Node Package

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip npm publish and release)'
        type: boolean
        default: true

  pull_request:
    branches:
      - main

env:
  MACOSX_DEPLOYMENT_TARGET: '10.13'
  CARGO_INCREMENTAL: 0

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-24.04
          # Linux arm64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04-arm
          # macOS x64
          - target: x86_64-apple-darwin
            os: macos-15-intel
          # macOS arm64
          - target: aarch64-apple-darwin
            os: macos-15
          # Windows x64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
          # Windows arm64
          - target: aarch64-pc-windows-msvc
            os: windows-11-arm
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Rust (Unix)
        if: runner.os != 'Windows'
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install Rust (Windows)
        if: runner.os == 'Windows'
        run: |
          Invoke-WebRequest -Uri https://win.rustup.rs/x86_64 -OutFile rustup-init.exe
          .\rustup-init.exe -y --default-toolchain stable
          echo "$env:USERPROFILE\.cargo\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      # we set bash so that it also works for Windows runners
      - name: Install napi-rs cli
        shell: bash
        run: |
          NAPI_VERSION=$(node -p "require('./package.json').devDependencies['@napi-rs/cli']")
          pnpm add @napi-rs/cli@$NAPI_VERSION
        working-directory: node

      - name: Build
        run: pnpm build --target ${{ matrix.target }}
        working-directory: node

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ matrix.target }}
          path: node/*.node
          if-no-files-found: error

  publish:
    needs: [build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    defaults:
      run:
        working-directory: node
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install napi-rs cli
        run: |
          NAPI_VERSION=$(node -p "require('./package.json').devDependencies['@napi-rs/cli']")
          pnpm add @napi-rs/cli@$NAPI_VERSION

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: node/artifacts

      - name: Move artifacts
        run: |
          ls -la artifacts/
          pnpm artifacts --dir artifacts

      - name: List packages
        run: ls -la npm/

      - name: Dry run
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          echo "Dry run - would publish:"
          for dir in npm/*/; do
            echo "  - $dir"
            cat "$dir/package.json" | grep -E '"name"|"version"'
          done
          echo "Main package:"
          cat package.json | grep -E '"name"|"version"'

      - name: Publish to npm
        if: ${{ !github.event_name == 'pull_request' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          find npm -maxdepth 1 -type d -mindepth 1 -exec npm publish --access public {} \;
          npm publish --access public

      - name: Create draft release
        if: ${{ !github.event_name == 'pull_request' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=$(jq -r '.version' package.json)
          TAG="node/${VERSION}"
          echo "version: ${VERSION}"
          echo "tag: ${TAG}"

          git tag "$TAG"
          git push origin "$TAG"

          gh release create --draft --repo ${{ github.repository }} \
            --verify-tag "$TAG" \
            --title "atlas-node v${VERSION}" \
            --notes "Published @concrete-security/atlas-node@${VERSION} to npm"
