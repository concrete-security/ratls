# Publish @concrete-security/atlas-node to npm
#
# How to release:
#   1. Update version in node/package.json
#   2. Commit and push the change
#   3. Run this workflow with dry_run=false
#
# The workflow will:
#   - Build for all platforms
#   - Create git tag: node/<version>
#   - Create draft GitHub release
#   - Publish to npm

name: Publish Node Package

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip npm publish and release)'
        type: boolean
        default: true

  pull_request:
    branches:
      - main

env:
  MACOSX_DEPLOYMENT_TARGET: '10.13'
  CARGO_INCREMENTAL: 0

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux GNU targets use --use-napi-cross
          - target: x86_64-unknown-linux-gnu
            build_flags: "--use-napi-cross"
          - target: aarch64-unknown-linux-gnu
            build_flags: "--use-napi-cross"
          # All others use -x (zigbuild/xwin)
          - target: x86_64-apple-darwin
            build_flags: "-x"
          - target: aarch64-apple-darwin
            build_flags: "-x"
          - target: x86_64-pc-windows-msvc
            build_flags: "-x"
          - target: aarch64-pc-windows-msvc
            build_flags: "-x"
          - target: x86_64-unknown-linux-musl
            build_flags: "-x"
          - target: aarch64-unknown-linux-musl
            build_flags: "-x"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          source "$HOME/.cargo/env"
          rustup target add ${{ matrix.target }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ~/.xwin
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cross-compilation tools
        run: |
          cargo install cargo-zigbuild --locked || true
          cargo install cargo-xwin --locked || true

      - name: Setup zig
        run: |
          ZIG_VERSION="0.13.0"
          curl -sSfL "https://ziglang.org/download/${ZIG_VERSION}/zig-linux-x86_64-${ZIG_VERSION}.tar.xz" | tar -xJ
          echo "${PWD}/zig-linux-x86_64-${ZIG_VERSION}" >> $GITHUB_PATH

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: node

      - name: Build
        run: pnpm build --target ${{ matrix.target }} ${{ matrix.build_flags }}
        working-directory: node

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ matrix.target }}
          path: node/*.node
          if-no-files-found: error

  publish:
    needs: [build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    defaults:
      run:
        working-directory: node
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: node/artifacts

      - name: Move artifacts
        run: pnpm artifacts

      - name: List packages
        run: ls -la npm/

      - name: Dry run
        if: ${{ inputs.dry_run }}
        run: |
          echo "Dry run - would publish:"
          for dir in npm/*/; do
            echo "  - $dir"
            cat "$dir/package.json" | grep -E '"name"|"version"'
          done
          echo "Main package:"
          cat package.json | grep -E '"name"|"version"'

      - name: Publish to npm
        if: ${{ !inputs.dry_run }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          find npm -maxdepth 1 -type d -mindepth 1 -exec npm publish --access public {} \;
          npm publish --access public

      - name: Create draft release
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=$(jq -r '.version' package.json)
          TAG="node/${VERSION}"
          echo "version: ${VERSION}"
          echo "tag: ${TAG}"

          git tag "$TAG"
          git push origin "$TAG"

          gh release create --draft --repo ${{ github.repository }} \
            --verify-tag "$TAG" \
            --title "atlas-node v${VERSION}" \
            --notes "Published @concrete-security/atlas-node@${VERSION} to npm"
