name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test-core:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: core
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run core tests
        run: cargo test --all-features
      - name: Install wasm32 target
        run: rustup target add wasm32-unknown-unknown
      - name: Check with wasm target
        run: cargo check --target wasm32-unknown-unknown --all-features

  test-proxy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run proxy unit tests
        run: cargo test -p atlas-proxy
      - name: Run proxy integration tests
        run: cargo test -p atlas-proxy --test integration

  test-wasm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      - name: Check WASM compilation
        run: cargo check -p atlas-wasm --target wasm32-unknown-unknown
      - name: Run WASM tests (Node.js)
        run: wasm-pack test --node wasm

  test-node:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Install napi-rs cli
        working-directory: node
        run: |
          NAPI_VERSION=$(node -p "require('./package.json').devDependencies['@napi-rs/cli']")
          pnpm add @napi-rs/cli@$NAPI_VERSION
      - name: Build native module
        working-directory: node
        run: pnpm build
      - name: Run node tests
        working-directory: node
        run: npm test

